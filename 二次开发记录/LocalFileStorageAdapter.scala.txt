actor-fs-adapters/src/main/scala/im/actor/server/file/local/LocalFileStorageAdapter.scala

  
  override def completeFileUpload(fileId: Long, fileSize: Long, fileName: UnsafeFileName, partNames: Seq[String]): Future[Unit] = {
    val fileDir = fileDirectory(fileId)
    for {
      isComplete ← haveAllParts(fileDir, partNames, fileSize)
      result ← concatFiles(fileDir, partNames, fileName.safe, fileSize)
      _ ← if (isComplete) deleteUploadedParts(fileDir, partNames) else Future.successful(())
      //添加音频转换支持  by Lining  2016-6-20
      _ ← if (isComplete && result.name.endsWith("voice.opus")) convertAudio(result.toJava) else Future { 0 }
      _ ← db.run(FileRepo.setUploaded(fileId, fileName.safe))
    } yield ()
  }
    
  
  /**
   * 转换音频文件（.aac和.ogg）
   * by Lining 2016-6-15
   *
   * @param audioFile
   */
  private def convertAudio(audioFile: java.io.File): Future[Int] = Future {
    val audioConverter = new com.justep.x5.sound.converter.AudioConverter
    if (audioConverter.isWavFile(audioFile)) {
      audioConverter.encodeWavToOgg(audioFile)
      audioConverter.encodeWavToAac(audioFile)
    }
    1
  }